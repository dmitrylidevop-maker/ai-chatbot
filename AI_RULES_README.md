# AI Behavior Rules - Static Data

## Описание

Таблица `static_data` содержит правила поведения AI и другие статические данные для настройки системы.

## Структура таблицы

```sql
CREATE TABLE static_data (
    id INTEGER PRIMARY KEY,
    category VARCHAR(100) NOT NULL,  -- Категория (например, 'ai_behavior')
    key VARCHAR(100) NOT NULL,        -- Ключ правила
    value TEXT NOT NULL,              -- Значение/описание правила
    description TEXT,                 -- Дополнительное описание
    is_active INTEGER DEFAULT 1,     -- 1 = активно, 0 = неактивно
    priority INTEGER DEFAULT 0,       -- Приоритет (больше = выше)
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

## Инициализированные правила AI

По умолчанию создаются следующие правила поведения AI (категория `ai_behavior`):

1. **Честность (priority: 100)**
   - Никогда не ври. Если не знаешь ответ, честно признайся в этом.

2. **Неизвестные ответы (priority: 95)**
   - Если не знаешь ответ на вопрос, ответь "Извини, я не знаю точного ответа на этот вопрос."

3. **Личность (priority: 90)**
   - Ты дружелюбный и полезный помощник. Общайся естественно и непринужденно.

4. **Уровень сарказма (priority: 85)**
   - Уровень сарказма: 50%. Используй легкий юмор и иронию в подходящих ситуациях, но не переборщи.

5. **Естественность (priority: 80)**
   - Веди себя естественно, как живой человек. Избегай излишне формальных фраз.

6. **Уважение (priority: 75)**
   - Всегда проявляй уважение к пользователю и его мнению.

7. **Полезность (priority: 70)**
   - Старайся быть максимально полезным. Предлагай дополнительную информацию, когда это уместно.

8. **Ясность (priority: 65)**
   - Давай четкие и понятные ответы. Избегай излишне сложных объяснений.

9. **Контекст (priority: 60)**
   - Учитывай контекст разговора и личную информацию пользователя для персонализации ответов.

10. **Эмодзи (priority: 55)**
    - Используй эмодзи умеренно для дружелюбности, но не злоупотребляй ими.

## Инициализация правил

Для создания правил в базе данных выполните:

```bash
python3 init_ai_rules.py
```

Скрипт автоматически:
- Создаст все необходимые таблицы
- Добавит 10 базовых правил поведения AI
- Пропустит инициализацию, если правила уже существуют

## API для управления правилами

### Получить все правила поведения AI

```bash
GET /static-data/ai-behavior
```

Возвращает список всех активных правил в порядке приоритета.

### Получить правила по категории

```bash
GET /static-data/{category}
```

Параметры:
- `category` - категория (например, `ai_behavior`)

### Создать новое правило

```bash
POST /static-data/
Content-Type: application/json

{
  "category": "ai_behavior",
  "key": "new_rule",
  "value": "Описание нового правила",
  "description": "Дополнительное описание",
  "priority": 50
}
```

### Обновить существующее правило

```bash
PATCH /static-data/{rule_id}
Content-Type: application/json

{
  "value": "Новое описание правила",
  "is_active": 1,
  "priority": 75
}
```

Параметры (все опциональные):
- `value` - новое значение правила
- `is_active` - 1 (активно) или 0 (неактивно)
- `priority` - новый приоритет

### Перезагрузить правила

```bash
POST /static-data/reload-ai-rules
```

Принудительно перезагружает правила из базы данных в кэш OllamaService.

## Использование в коде

### Получение правил

```python
from app.services.database_service import db_service
from app.database import SessionLocal

db = SessionLocal()
rules = db_service.get_ai_behavior_rules(db)
db.close()
```

### Добавление нового правила

```python
from app.services.database_service import db_service
from app.database import SessionLocal

db = SessionLocal()
rule = db_service.add_static_data(
    db,
    category="ai_behavior",
    key="custom_rule",
    value="Моё кастомное правило",
    description="Описание",
    priority=50
)
db.close()

# Перезагрузить кэш
from app.services.ollama_service import ollama_service
ollama_service.reload_ai_rules()
```

### Обновление правила

```python
from app.services.database_service import db_service
from app.database import SessionLocal

db = SessionLocal()
updated_rule = db_service.update_static_data(
    db,
    rule_id=1,
    value="Обновленное значение",
    priority=100
)
db.close()

# Перезагрузить кэш
from app.services.ollama_service import ollama_service
ollama_service.reload_ai_rules()
```

## Как это работает

1. **Загрузка правил**: При первом обращении `OllamaService` загружает правила из базы данных и кэширует их
2. **Формирование промпта**: При каждом сообщении пользователя правила добавляются в system message для Ollama
3. **Приоритет**: Правила сортируются по убыванию приоритета (большее число = выше приоритет)
4. **Активность**: Неактивные правила (is_active=0) не используются
5. **Кэширование**: Правила кэшируются для производительности, но можно принудительно перезагрузить

## Примеры промптов с правилами

Когда пользователь отправляет сообщение, system message выглядит так:

```
ПРАВИЛА ПОВЕДЕНИЯ:
1. Никогда не ври. Если не знаешь ответ, честно признайся в этом.
2. Если не знаешь ответ на вопрос, ответь "Извини, я не знаю точного ответа на этот вопрос."
3. Ты дружелюбный и полезный помощник. Общайся естественно и непринужденно.
4. Уровень сарказма: 50%. Используй легкий юмор и иронию в подходящих ситуациях.
5. Веди себя естественно, как живой человек. Избегай излишне формальных фраз.
... (остальные правила)

ИНФОРМАЦИЯ О ПОЛЬЗОВАТЕЛЕ:
Имя пользователя: Дмитрий
О пользователе: Программист из России
Личная информация:
- возраст: 25
- интересы: программирование, путешествия

ВАЖНО: Пользователь пишет на языке: русский. Отвечай ОБЯЗАТЕЛЬНО на том же языке.

Используй информацию о пользователе для персонализации разговора.
```

## Расширение системы

Вы можете добавлять свои категории данных:

```python
# Добавить правило модерации контента
db_service.add_static_data(
    db,
    category="content_moderation",
    key="profanity_filter",
    value="Не использовать ненормативную лексику",
    priority=100
)

# Добавить настройки форматирования
db_service.add_static_data(
    db,
    category="formatting",
    key="code_blocks",
    value="Используй блоки кода для примеров программирования",
    priority=50
)
```

## Советы по использованию

1. **Приоритет**: Самые важные правила должны иметь высокий приоритет (90-100)
2. **Активность**: Временно отключайте правила вместо удаления (is_active=0)
3. **Категории**: Используйте разные категории для разных типов правил
4. **Перезагрузка**: Не забывайте перезагружать кэш после изменений правил
5. **Тестирование**: Тестируйте новые правила перед добавлением в продакшн

## Мониторинг

Проверить, какие правила используются:

```bash
# Через API
curl http://localhost:8000/static-data/ai-behavior

# Через базу данных
psql -h 192.168.31.129 -p 5435 -U postgres -d postgres \
  -c "SELECT * FROM static_data WHERE category='ai_behavior' AND is_active=1 ORDER BY priority DESC;"
```
